{% extends 'layout.html' %}

{% block body %}
  {% set subData1 = filesData.loc[filesData['who']==who] %}
  <div class="container">
    <h1>Material for {{who}}</h1>
    <hr>
    {% for workshop in workshopList %}
      {% set Wloop = loop.index %}
      {% set subData2 = subData1.loc[subData1['workshop']==workshop] %}
      <h2>Workshop on {{workshop}}</h2>
      <div class="panel-group">
        {% for iday in range(1,6) %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#collapseW{{Wloop}}D{{iday}}">Day {{iday}}</a>
            </h4>
          </div>
          <div id="collapseW{{Wloop}}D{{iday}}" class="panel-collapse collapse">
            <div class="panel-body">
              {% for type in ['lectures','practicals'] %}
              {% set Tloop = loop.index %}
                <div class="panel panel-default">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" href="#collapseW{{Wloop}}D{{iday}}T{{Tloop}}">{{type}}</a>
                    </h4>
                  </div>
                  <div id="collapseW{{Wloop}}D{{iday}}T{{Tloop}}" class="panel-collapse collapse">
                    <div class="panel-body">
                        {% set subData3 = subData2.loc[subData1['type']==type+iday|string] %}
                        {% for index, row in subData3.iterrows() %}
                          <h4>
                            {% if S3_OR_DBX == 'S3' %}
                              <a href="#" onclick="getSignedRequestForDownload({{row['id']}})">
                                <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                                {{row['title']}}
                              </a>
                            {% elif S3_OR_DBX == 'DBX' %}
                              <form action=/download-file/{{row['id']}} method="post">
                                <a href="#" onclick="this.parentNode.submit()">
                                  <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                                  {{row['title']}}
                                </a>
                              </form>
                            {% endif %}
                            <small>Uploaded by <b>{{row['author']}}</b></small>
                          </h4>
                          {% if session.username == row['author'] or session.username == 'admin' %}
                            <form action=/edit/{{row['id']}}/{{S3_OR_DBX}} method="post" style="display:inline;">
                              <input type="submit" name="edit" value="Edit" class="btn btn-primary">
                            </form>
                            <form action=/delete-file/{{row['id']}} method="post" onsubmit="return confirm('Are you sure?');" style="display:inline;">
                              <input type="hidden" name="_method" value="DELETE">
                              <input type="submit" value="Delete" class="btn btn-danger">
                            </form>
                          {% endif %}
                          <p style="font-size:18px">{{row['description']}}</p>
                          {% if loop.index != subData3|length %}
                            <hr style="height:2px" />
                          {% endif %}
                        {% endfor %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#collapseW{{Wloop}}D0">Other</a>
            </h4>
          </div>
          <div id="collapseW{{Wloop}}D0" class="panel-collapse collapse">
            <div class="panel-body">
              {% set subData4 = subData2.loc[subData1['type']=='other'] %}
              {% for index, row in subData4.iterrows() %}
                <h4>
                  {% if S3_OR_DBX == 'S3' %}
                    <a href="#" onclick="getSignedRequestForDownload({{row['id']}})">
                      <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                      {{row['title']}}
                    </a>
                  {% elif S3_OR_DBX == 'DBX' %}
                    <form action=/download-file/{{row['id']}} method="post">
                      <a href="#" onclick="this.parentNode.submit()">
                        <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span>
                        {{row['title']}}
                      </a>
                    </form>
                  {% endif %}
                  <small>Uploaded by <b>{{row['author']}}</b></small>
                </h4>
                {% if session.username == row['author'] or session.username == 'admin' %}
                  <form action=/edit/{{row['id']}}/{{S3_OR_DBX}} method="post" style="display:inline;">
                    <input type="submit" name="edit" value="Edit" class="btn btn-primary">
                  </form>
                  <form action=/delete-file/{{row['id']}} method="post" onsubmit="return confirm('Are you sure?');" style="display:inline;">
                    <input type="hidden" name="_method" value="DELETE">
                    <input type="submit" value="Delete" class="btn btn-danger">
                  </form>
                {% endif %}
                <p style="font-size:18px">{{row['description']}}</p>
                {% if loop.index != subData4|length %}
                  <hr style="height:2px" />
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      <hr>
    {% endfor %}
  </div>
{% endblock %}

{% block scripts %}
{% if S3_OR_DBX == 'S3' %}
<script>

function getSignedRequestForDownload(id){
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "/sign_s3_download_file?id="+id);
  xhr.onreadystatechange = function(){
    if(xhr.readyState === 4){
      if(xhr.status === 200){
        var response = JSON.parse(xhr.responseText);
        window.open(response.url);
      }
      else{
        alert("Could not get signed URL.");
      }
    }
  };
  xhr.send();
}

</script>
{% endif %}
{% endblock %}
